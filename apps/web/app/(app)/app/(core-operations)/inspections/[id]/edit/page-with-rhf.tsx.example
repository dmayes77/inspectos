/**
 * Example: Inspection Edit Page with React Hook Form + Zod
 * 
 * This is an example showing how to migrate the current form to use React Hook Form.
 * To use this, rename this file and replace the current edit page.
 * 
 * Benefits:
 * - Type-safe form validation
 * - Better error handling
 * - Less boilerplate
 * - Better performance (uncontrolled components)
 */

"use client";
import { useEffect } from "react";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { useParams, useRouter } from "next/navigation";
import Link from "next/link";
import { AppShell } from "@/components/layout/app-shell";
import { AdminPageHeader } from "@/components/layout/admin-page-header";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Checkbox } from "@/components/ui/checkbox";
import { Badge } from "@/components/ui/badge";
import { ChevronLeft } from "lucide-react";
import { useServices } from "@/hooks/use-services";
import { useGet } from "@/hooks/crud";
import { getClients } from "@/lib/mock/clients";
import { getInspectionById } from "@/lib/mock/inspections";
import { useInspectors } from "@/hooks/use-team";
import { useUpdateInspection, useCreateInspection } from "@/hooks/use-inspections";
import { mockAdminUser } from "@/lib/constants/mock-users";
import { FOUNDATION_OPTIONS, GARAGE_OPTIONS, STORY_OPTIONS } from "@/lib/constants/property-options";
import { parseAddress } from "@/lib/utils/address";
import { calculateServiceTotal } from "@/lib/utils/pricing";
import { booleanToYesNo, yesNoToBoolean } from "@/lib/utils/formatters";
import { toast } from "sonner";
import { inspectionSchema, type InspectionFormData } from "@/lib/validations/inspection";
import { formatDateTime } from "@/lib/utils/dates";
import type { Inspection } from "@/types/inspection";

export default function EditInspectionPage(props: { isNew?: boolean } = {}) {
  const params = useParams();
  const router = useRouter();
  const { data: services = [] } = useServices();
  const { data: clientsData = [] } = useGet("clients", async () => getClients());
  const clients = clientsData;
  const [showClientForm, setShowClientForm] = useState(false);

  // Get inspection by ID
  const inspectionId = typeof params.id === "string" ? params.id : undefined;
  const { data: inspection } = useGet<Inspection | null>(
    inspectionId ? `inspection-${inspectionId}` : "inspection-new",
    async () => {
      if (!inspectionId || props.isNew) return null;
      return getInspectionById(inspectionId) || null;
    }
  );

  const { data: inspectors = [] } = useInspectors();
  const updateMutation = useUpdateInspection();
  const createMutation = useCreateInspection();

  // Parse address for default values
  const addressParts = inspection ? parseAddress(inspection.address) : { street: "", city: "", state: "", zip: "" };

  // React Hook Form setup
  const {
    register,
    handleSubmit,
    formState: { errors, isSubmitting },
    watch,
    setValue,
    reset,
  } = useForm<InspectionFormData>({
    resolver: zodResolver(inspectionSchema),
    defaultValues: inspection
      ? {
          street: addressParts.street,
          city: addressParts.city,
          state: addressParts.state,
          zip: addressParts.zip,
          sqft: inspection.sqft,
          yearBuilt: inspection.yearBuilt,
          bedrooms: inspection.bedrooms,
          bathrooms: inspection.bathrooms,
          stories: inspection.stories,
          propertyType: inspection.propertyType,
          foundation: inspection.foundation,
          garage: inspection.garage,
          pool: booleanToYesNo(inspection.pool),
          clientId: inspection.clientId || "",
          inspectorId: inspection.inspectorId || "",
          date: inspection.date,
          time: inspection.time,
          status: inspection.status,
          notes: inspection.notes,
          types: Array.isArray(inspection.types) ? inspection.types : [],
        }
      : {
          types: [],
        },
  });

  // Watch selected service types for price calculation
  const selectedTypeIds = watch("types") || [];
  const calculatedPrice = useMemo(() => calculateServiceTotal(selectedTypeIds, services), [selectedTypeIds, services]);

  // Reset form when inspection loads
  useEffect(() => {
    if (inspection) {
      const addressParts = parseAddress(inspection.address);
      reset({
        street: addressParts.street,
        city: addressParts.city,
        state: addressParts.state,
        zip: addressParts.zip,
        sqft: inspection.sqft,
        yearBuilt: inspection.yearBuilt,
        bedrooms: inspection.bedrooms,
        bathrooms: inspection.bathrooms,
        stories: inspection.stories,
        propertyType: inspection.propertyType,
        foundation: inspection.foundation,
        garage: inspection.garage,
        pool: booleanToYesNo(inspection.pool),
        clientId: inspection.clientId || "",
        inspectorId: inspection.inspectorId || "",
        date: inspection.date,
        time: inspection.time,
        status: inspection.status,
        notes: inspection.notes,
        types: Array.isArray(inspection.types) ? inspection.types : [],
      });
    }
  }, [inspection, reset]);

  const onSubmit = async (data: InspectionFormData) => {
    const clientObj = clients.find((c) => c.clientId === data.clientId);
    const inspectorObj = inspectors.find((i) => i.teamMemberId === data.inspectorId);

    const payload: Partial<Inspection> & { types?: string[] } = {
      address: `${data.street}, ${data.city} ${data.state} ${data.zip}`.trim(),
      types: data.types,
      client: clientObj?.name || "",
      clientId: data.clientId,
      inspector: inspectorObj?.name || "",
      inspectorId: inspectorObj?.teamMemberId || "",
      date: data.date,
      time: data.time,
      status: data.status || "scheduled",
      sqft: data.sqft,
      yearBuilt: data.yearBuilt,
      bedrooms: data.bedrooms,
      bathrooms: data.bathrooms,
      stories: data.stories,
      propertyType: data.propertyType,
      foundation: data.foundation,
      garage: data.garage,
      pool: yesNoToBoolean(data.pool),
      notes: data.notes,
      price: calculatedPrice,
    };

    if (inspection?.inspectionId) {
      updateMutation.mutate(
        { inspectionId: inspection.inspectionId, ...payload },
        {
          onSuccess: () => {
            toast.success("Inspection updated successfully");
            router.push(`/admin/inspections/${inspection.inspectionId}`);
          },
          onError: (error) => {
            const errorMessage = error instanceof Error ? error.message : "Failed to update inspection";
            toast.error(errorMessage);
          },
        }
      );
    } else {
      createMutation.mutate(payload, {
        onSuccess: (data) => {
          toast.success("Inspection created successfully");
          router.push(data?.inspectionId ? `/admin/inspections/${data.inspectionId}` : "/admin/inspections");
        },
        onError: (error) => {
          const errorMessage = error instanceof Error ? error.message : "Failed to create inspection";
          toast.error(errorMessage);
        },
      });
    }
  };

  // Early return if inspection not found
  if (!inspection && !props.isNew) {
    return (
      <AppShell user={mockAdminUser}>
        <div className="space-y-6">
          <Button variant="ghost" asChild>
            <Link href="/admin/inspections">
              <ChevronLeft className="mr-2 h-4 w-4" />
              Back to Inspections
            </Link>
          </Button>
          <div className="text-center py-12">
            <h1 className="text-2xl font-semibold mb-2">Inspection Not Found</h1>
            <p className="text-muted-foreground">The inspection you are looking for does not exist.</p>
          </div>
        </div>
      </AppShell>
    );
  }

  return (
    <AppShell user={mockAdminUser}>
      <div className="space-y-4 w-full max-w-4xl">
        <Button variant="ghost" asChild>
          {inspection ? (
            <Link href={`/admin/inspections/${inspection.inspectionId}`}>
              <ChevronLeft className="mr-2 h-4 w-4" />
              Back to Inspection
            </Link>
          ) : (
            <Link href="/admin/inspections">
              <ChevronLeft className="mr-2 h-4 w-4" />
              Back to Inspections
            </Link>
          )}
        </Button>

        <AdminPageHeader
          title={inspection ? "Edit Inspection" : "New Inspection"}
          description={inspection ? `Update inspection ${inspection.inspectionId}` : "Create a new inspection appointment"}
        />

        <form onSubmit={handleSubmit(onSubmit)}>
          <div className="space-y-4">
            {/* Property Information */}
            <Card>
              <CardHeader>
                <CardTitle>Property Information</CardTitle>
                <CardDescription>Enter the property address and details</CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="space-y-2">
                  <Label htmlFor="street">
                    Street Address {errors.street && <span className="text-destructive">* {errors.street.message}</span>}
                  </Label>
                  <Input id="street" {...register("street")} placeholder="123 Main Street" />
                </div>

                <div className="grid gap-4 md:grid-cols-3">
                  <div className="space-y-2">
                    <Label htmlFor="city">
                      City {errors.city && <span className="text-destructive">* {errors.city.message}</span>}
                    </Label>
                    <Input id="city" {...register("city")} placeholder="Austin" />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="state">
                      State {errors.state && <span className="text-destructive">* {errors.state.message}</span>}
                    </Label>
                    <Input id="state" {...register("state")} placeholder="TX" maxLength={2} />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="zip">
                      ZIP Code {errors.zip && <span className="text-destructive">* {errors.zip.message}</span>}
                    </Label>
                    <Input id="zip" {...register("zip")} placeholder="78701" maxLength={5} />
                  </div>
                </div>

                {/* Rest of form fields using register() and error handling */}
                {/* ... */}
              </CardContent>
            </Card>

            {/* Services */}
            <Card>
              <CardHeader>
                <CardTitle>Services</CardTitle>
                {errors.types && <p className="text-sm text-destructive">{errors.types.message}</p>}
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-2 gap-2">
                  {services.map((service) => {
                    const checked = selectedTypeIds.includes(service.serviceId);
                    return (
                      <label key={service.serviceId} className="flex items-center gap-2">
                        <Checkbox
                          checked={checked}
                          onCheckedChange={(isChecked) => {
                            const current = selectedTypeIds;
                            if (isChecked) {
                              setValue("types", [...current, service.serviceId]);
                            } else {
                              setValue("types", current.filter((id) => id !== service.serviceId));
                            }
                          }}
                        />
                        <span>{service.name}</span>
                      </label>
                    );
                  })}
                </div>
              </CardContent>
            </Card>

            <div className="flex gap-4">
              <Button type="submit" disabled={isSubmitting}>
                {isSubmitting ? "Saving..." : "Save Changes"}
              </Button>
              <Button type="button" variant="outline" asChild>
                <Link href={inspection ? `/admin/inspections/${inspection.inspectionId}` : "/admin/inspections"}>
                  Cancel
                </Link>
              </Button>
            </div>
          </div>
        </form>
      </div>
    </AppShell>
  );
}
